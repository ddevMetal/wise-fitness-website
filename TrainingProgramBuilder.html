<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Training Program Builder - Wise Fitness</title>
  <style>
    :root {
      --primary-color: #007bff;
      --primary-dark: #0056b3;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-radius: 8px;
      --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: var(--dark-color);
      line-height: 1.6;
    }

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    /* Modal Container */
    .modal-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Modal Header */
    .modal-header {
      background: var(--primary-color);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: var(--transition);
    }

    .close-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    /* Progress Bar */
    .progress-container {
      background: var(--light-color);
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .progress-text {
      margin-top: 8px;
      font-size: 0.875rem;
      color: var(--secondary-color);
      text-align: center;
    }

    /* Modal Body */
    .modal-body {
      padding: 30px;
    }

    /* Step Container */
    .step {
      display: none;
    }

    .step.active {
      display: block;
      animation: stepFadeIn 0.3s ease-in;
    }

    @keyframes stepFadeIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .step-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary-color);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark-color);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Checkbox Groups */
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .checkbox-item:hover {
      border-color: var(--primary-color);
      background-color: rgba(0, 123, 255, 0.05);
    }

    .checkbox-item.selected {
      border-color: var(--primary-color);
      background-color: rgba(0, 123, 255, 0.1);
    }

    .checkbox-item input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }

    /* Exercise Builder */
    .exercise-list {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #e9ecef;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }

    .exercise-category {
      background: var(--light-color);
      padding: 15px;
      border-bottom: 1px solid #dee2e6;
      font-weight: 600;
      color: var(--primary-color);
    }

    .exercise-item {
      padding: 15px;
      border-bottom: 1px solid #f8f9fa;
      cursor: pointer;
      transition: var(--transition);
    }

    .exercise-item:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }

    .exercise-item.selected {
      background-color: rgba(0, 123, 255, 0.1);
      border-left: 4px solid var(--primary-color);
    }

    .exercise-name {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .exercise-description {
      font-size: 0.875rem;
      color: var(--secondary-color);
    }

    /* Exercise Configuration */
    .exercise-config {
      background: var(--light-color);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-top: 20px;
    }

    .config-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    /* Selected Exercises Display */
    .selected-exercises {
      margin-top: 20px;
    }

    .selected-exercise {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .exercise-details {
      flex-grow: 1;
    }

    .remove-exercise {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .remove-exercise:hover {
      background: #c82333;
    }

    /* Navigation Buttons */
    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Trigger Button */
    .open-builder-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
      transition: var(--transition);
      z-index: 100;
    }

    .open-builder-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 123, 255, 0.4);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .modal-container {
        width: 95%;
        margin: 10px;
      }

      .modal-body {
        padding: 20px;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }

      .config-row {
        grid-template-columns: 1fr;
      }

      .open-builder-btn {
        bottom: 20px;
        right: 20px;
        padding: 12px 16px;
      }
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Success Message */
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: var(--border-radius);
      border: 1px solid #c3e6cb;
      margin-bottom: 20px;
      display: none;
    }

    .success-message.show {
      display: block;
    }
  </style>
</head>
<body>

  <!-- Trigger Button -->
  <button class="open-builder-btn" onclick="openTrainingBuilder()">
    + Create Training Program
  </button>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="trainingBuilderModal">
    <div class="modal-container">
      <!-- Header -->
      <div class="modal-header">
        <h2 class="modal-title">Training Program Builder</h2>
        <button class="close-btn" onclick="closeTrainingBuilder()">&times;</button>
      </div>

      <!-- Progress Bar -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Step 1 of 6</div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- Success Message -->
        <div class="success-message" id="successMessage">
          ✓ Training program saved successfully!
        </div>

        <!-- Step 1: Program Details -->
        <div class="step active" id="step1">
          <h3 class="step-title">Program Details</h3>
          <div class="form-group">
            <label class="form-label" for="programTitle">Program Title *</label>
            <input type="text" id="programTitle" class="form-input" placeholder="e.g., 4 Weeks Hardcore Abs" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="programDescription">Program Description</label>
            <textarea id="programDescription" class="form-textarea" placeholder="Describe the program goals and target audience..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="programDuration">Program Duration *</label>
            <select id="programDuration" class="form-select" required>
              <option value="">Select Duration</option>
              <option value="1_week">1 Week</option>
              <option value="2_weeks">2 Weeks</option>
              <option value="3_weeks">3 Weeks</option>
              <option value="4_weeks">4 Weeks</option>
              <option value="6_weeks">6 Weeks</option>
              <option value="8_weeks">8 Weeks</option>
              <option value="12_weeks">12 Weeks</option>
              <option value="custom">Custom Duration</option>
            </select>
          </div>
          <div class="form-group" id="customDurationGroup" style="display: none;">
            <label class="form-label" for="customDuration">Custom Duration (weeks)</label>
            <input type="number" id="customDuration" class="form-input" min="1" max="52" placeholder="Enter number of weeks">
          </div>
        </div>

        <!-- Step 2: Weekly Schedule -->
        <div class="step" id="step2">
          <h3 class="step-title">Weekly Schedule</h3>
          <div class="form-group">
            <label class="form-label">How many days per week? *</label>
            <div class="checkbox-group">
              <div class="checkbox-item" onclick="selectFrequency('3_days')">
                <input type="radio" name="frequency" value="3_days" id="freq3">
                <label for="freq3">3 Days/Week</label>
              </div>
              <div class="checkbox-item" onclick="selectFrequency('4_days')">
                <input type="radio" name="frequency" value="4_days" id="freq4">
                <label for="freq4">4 Days/Week</label>
              </div>
              <div class="checkbox-item" onclick="selectFrequency('5_days')">
                <input type="radio" name="frequency" value="5_days" id="freq5">
                <label for="freq5">5 Days/Week</label>
              </div>
              <div class="checkbox-item" onclick="selectFrequency('6_days')">
                <input type="radio" name="frequency" value="6_days" id="freq6">
                <label for="freq6">6 Days/Week</label>
              </div>
              <div class="checkbox-item" onclick="selectFrequency('7_days')">
                <input type="radio" name="frequency" value="7_days" id="freq7">
                <label for="freq7">7 Days/Week</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Training Days Selection -->
        <div class="step" id="step3">
          <h3 class="step-title">Select Training Days</h3>
          <div class="form-group">
            <label class="form-label">Choose which days to train *</label>
            <div class="checkbox-group">
              <div class="checkbox-item" onclick="toggleDay('monday')">
                <input type="checkbox" id="monday" value="monday">
                <label for="monday">Monday</label>
              </div>
              <div class="checkbox-item" onclick="toggleDay('tuesday')">
                <input type="checkbox" id="tuesday" value="tuesday">
                <label for="tuesday">Tuesday</label>
              </div>
              <div class="checkbox-item" onclick="toggleDay('wednesday')">
                <input type="checkbox" id="wednesday" value="wednesday">
                <label for="wednesday">Wednesday</label>
              </div>
              <div class="checkbox-item" onclick="toggleDay('thursday')">
                <input type="checkbox" id="thursday" value="thursday">
                <label for="thursday">Thursday</label>
              </div>
              <div class="checkbox-item" onclick="toggleDay('friday')">
                <input type="checkbox" id="friday" value="friday">
                <label for="friday">Friday</label>
              </div>
              <div class="checkbox-item" onclick="toggleDay('saturday')">
                <input type="checkbox" id="saturday" value="saturday">
                <label for="saturday">Saturday</label>
              </div>
              <div class="checkbox-item" onclick="toggleDay('sunday')">
                <input type="checkbox" id="sunday" value="sunday">
                <label for="sunday">Sunday</label>
              </div>
            </div>
            <div id="daySelectionCount" style="margin-top: 15px; color: var(--secondary-color);"></div>
          </div>
        </div>

        <!-- Step 4: Training Style -->
        <div class="step" id="step4">
          <h3 class="step-title">Training Style & Approach</h3>
          <div class="form-group">
            <label class="form-label">Select Training Style *</label>
            <div class="checkbox-group">
              <div class="checkbox-item" onclick="selectTrainingStyle('standard_gym')">
                <input type="radio" name="trainingStyle" value="standard_gym" id="styleStandard">
                <label for="styleStandard">Standard Gym (Reps & Sets)</label>
              </div>
              <div class="checkbox-item" onclick="selectTrainingStyle('metabolic_circuit')">
                <input type="radio" name="trainingStyle" value="metabolic_circuit" id="styleMetabolic">
                <label for="styleMetabolic">Metabolic Circuit</label>
              </div>
              <div class="checkbox-item" onclick="selectTrainingStyle('amrap')">
                <input type="radio" name="trainingStyle" value="amrap" id="styleAmrap">
                <label for="styleAmrap">AMRAP (As Many Reps As Possible)</label>
              </div>
              <div class="checkbox-item" onclick="selectTrainingStyle('time_based')">
                <input type="radio" name="trainingStyle" value="time_based" id="styleTime">
                <label for="styleTime">Time-Based Training</label>
              </div>
              <div class="checkbox-item" onclick="selectTrainingStyle('hybrid')">
                <input type="radio" name="trainingStyle" value="hybrid" id="styleHybrid">
                <label for="styleHybrid">Hybrid (Mix of Styles)</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Exercise Selection -->
        <div class="step" id="step5">
          <h3 class="step-title">Build Your Workouts</h3>
          <div id="workoutDaysContainer">
            <!-- Dynamic content will be generated here -->
          </div>
        </div>

        <!-- Step 6: Review & Save -->
        <div class="step" id="step6">
          <h3 class="step-title">Review & Save Program</h3>
          <div id="programReview">
            <!-- Program summary will be generated here -->
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">Previous</button>
        <div>
          <button class="btn btn-secondary" onclick="closeTrainingBuilder()">Cancel</button>
          <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">Next</button>
          <button class="btn btn-success" id="saveBtn" onclick="saveProgram()" style="display: none;">
            <span id="saveSpinner" class="loading-spinner" style="display: none;"></span>
            Save Program
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase configuration - Replace with your config
    const firebaseConfig = {
      apiKey: "AIzaSyAIFV7ynXUzA0p-CrmVOE2lFRgaf_9g_k4",
      authDomain: "fyp-25-s2-09.firebaseapp.com",
      projectId: "fyp-25-s2-09",
      storageBucket: "fyp-25-s2-09.appspot.com",
      messagingSenderId: "838641447649",
      appId: "1:838641447649:web:6ddfb234b3d445f16dbda0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let currentStep = 1;
    const totalSteps = 6;
    let programData = {
      title: '',
      description: '',
      duration: '',
      frequency: '',
      trainingDays: [],
      trainingStyle: '',
      workouts: {},
      createdBy: '',
      createdAt: null
    };

    // Exercise database - This would typically come from Firestore
    const exerciseDatabase = {
      core: {
        abs: [
          { id: 'plank', name: 'Plank', description: 'Hold a plank position', category: 'Core', subcategory: 'Abs' },
          { id: 'crunches', name: 'Crunches', description: 'Basic abdominal crunches', category: 'Core', subcategory: 'Abs' },
          { id: 'bicycle_crunches', name: 'Bicycle Crunches', description: 'Alternating bicycle motion crunches', category: 'Core', subcategory: 'Abs' },
          { id: 'mountain_climbers', name: 'Mountain Climbers', description: 'Dynamic core exercise', category: 'Core', subcategory: 'Abs' },
          { id: 'russian_twists', name: 'Russian Twists', description: 'Rotational core movement', category: 'Core', subcategory: 'Abs' },
          { id: 'leg_raises', name: 'Leg Raises', description: 'Lower abdominal exercise', category: 'Core', subcategory: 'Abs' },
          { id: 'dead_bug', name: 'Dead Bug', description: 'Core stability exercise', category: 'Core', subcategory: 'Abs' },
          { id: 'hollow_hold', name: 'Hollow Hold', description: 'Isometric core hold', category: 'Core', subcategory: 'Abs' }
        ],
        obliques: [
          { id: 'side_plank', name: 'Side Plank', description: 'Lateral core stability', category: 'Core', subcategory: 'Obliques' },
          { id: 'wood_chops', name: 'Wood Chops', description: 'Rotational movement', category: 'Core', subcategory: 'Obliques' },
          { id: 'side_crunches', name: 'Side Crunches', description: 'Lateral flexion exercise', category: 'Core', subcategory: 'Obliques' }
        ]
      },
      upper_body: {
        chest: [
          { id: 'push_ups', name: 'Push-ups', description: 'Classic chest exercise', category: 'Upper Body', subcategory: 'Chest' },
          { id: 'bench_press', name: 'Bench Press', description: 'Heavy chest exercise', category: 'Upper Body', subcategory: 'Chest' },
          { id: 'chest_fly', name: 'Chest Fly', description: 'Isolation chest exercise', category: 'Upper Body', subcategory: 'Chest' }
        ],
        back: [
          { id: 'pull_ups', name: 'Pull-ups', description: 'Vertical pulling exercise', category: 'Upper Body', subcategory: 'Back' },
          { id: 'rows', name: 'Rows', description: 'Horizontal pulling exercise', category: 'Upper Body', subcategory: 'Back' },
          { id: 'lat_pulldown', name: 'Lat Pulldown', description: 'Latissimus dorsi exercise', category: 'Upper Body', subcategory: 'Back' }
        ]
      },
      lower_body: {
        quads: [
          { id: 'squats', name: 'Squats', description: 'Fundamental leg exercise', category: 'Lower Body', subcategory: 'Quadriceps' },
          { id: 'lunges', name: 'Lunges', description: 'Unilateral leg exercise', category: 'Lower Body', subcategory: 'Quadriceps' },
          { id: 'leg_press', name: 'Leg Press', description: 'Machine-based leg exercise', category: 'Lower Body', subcategory: 'Quadriceps' }
        ],
        glutes: [
          { id: 'hip_thrusts', name: 'Hip Thrusts', description: 'Glute activation exercise', category: 'Lower Body', subcategory: 'Glutes' },
          { id: 'glute_bridges', name: 'Glute Bridges', description: 'Basic glute exercise', category: 'Lower Body', subcategory: 'Glutes' },
          { id: 'deadlifts', name: 'Deadlifts', description: 'Posterior chain exercise', category: 'Lower Body', subcategory: 'Glutes' }
        ]
      }
    };

    // Modal functions
    window.openTrainingBuilder = function() {
      document.getElementById('trainingBuilderModal').classList.add('active');
      resetBuilder();
    };

    window.closeTrainingBuilder = function() {
      document.getElementById('trainingBuilderModal').classList.remove('active');
    };

    function resetBuilder() {
      currentStep = 1;
      programData = {
        title: '',
        description: '',
        duration: '',
        frequency: '',
        trainingDays: [],
        trainingStyle: '',
        workouts: {},
        createdBy: '',
        createdAt: null
      };
      showStep(1);
      updateProgress();
      clearForm();
    }

    function clearForm() {
      document.getElementById('programTitle').value = '';
      document.getElementById('programDescription').value = '';
      document.getElementById('programDuration').value = '';
      document.getElementById('customDuration').value = '';
      document.getElementById('customDurationGroup').style.display = 'none';
      
      // Clear radio buttons and checkboxes
      document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
      document.querySelectorAll('.checkbox-item').forEach(item => item.classList.remove('selected'));
      
      document.getElementById('successMessage').classList.remove('show');
    }

    // Step navigation
    window.nextStep = function() {
      if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
          currentStep++;
          if (currentStep === 5) {
            generateWorkoutDays();
          } else if (currentStep === 6) {
            generateProgramReview();
          }
          showStep(currentStep);
          updateProgress();
        }
      }
    };

    window.previousStep = function() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgress();
      }
    };

    function showStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      
      // Update navigation buttons
      document.getElementById('prevBtn').style.display = step > 1 ? 'block' : 'none';
      document.getElementById('nextBtn').style.display = step < totalSteps ? 'block' : 'none';
      document.getElementById('saveBtn').style.display = step === totalSteps ? 'block' : 'none';
    }

    function updateProgress() {
      const progressPercent = (currentStep / totalSteps) * 100;
      document.getElementById('progressFill').style.width = progressPercent + '%';
      document.getElementById('progressText').textContent = `Step ${currentStep} of ${totalSteps}`;
    }

    // Validation functions
    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          return validateProgramDetails();
        case 2:
          return validateWeeklySchedule();
        case 3:
          return validateTrainingDays();
        case 4:
          return validateTrainingStyle();
        case 5:
          return validateExerciseSelection();
        default:
          return true;
      }
    }

    function validateProgramDetails() {
      const title = document.getElementById('programTitle').value.trim();
      const duration = document.getElementById('programDuration').value;
      
      if (!title) {
        alert('Please enter a program title.');
        return false;
      }
      
      if (!duration) {
        alert('Please select a program duration.');
        return false;
      }
      
      if (duration === 'custom') {
        const customDuration = document.getElementById('customDuration').value;
        if (!customDuration || customDuration < 1 || customDuration > 52) {
          alert('Please enter a valid custom duration (1-52 weeks).');
          return false;
        }
        programData.duration = `${customDuration}_weeks`;
      } else {
        programData.duration = duration;
      }
      
      programData.title = title;
      programData.description = document.getElementById('programDescription').value.trim();
      return true;
    }

    function validateWeeklySchedule() {
      const frequency = document.querySelector('input[name="frequency"]:checked');
      if (!frequency) {
        alert('Please select how many days per week to train.');
        return false;
      }
      programData.frequency = frequency.value;
      return true;
    }

    function validateTrainingDays() {
      const selectedDays = document.querySelectorAll('#step3 input[type="checkbox"]:checked');
      const expectedDays = parseInt(programData.frequency.split('_')[0]);
      
      if (selectedDays.length !== expectedDays) {
        alert(`Please select exactly ${expectedDays} training days.`);
        return false;
      }
      
      programData.trainingDays = Array.from(selectedDays).map(day => day.value);
      return true;
    }

    function validateTrainingStyle() {
      const style = document.querySelector('input[name="trainingStyle"]:checked');
      if (!style) {
        alert('Please select a training style.');
        return false;
      }
      programData.trainingStyle = style.value;
      return true;
    }

    function validateExerciseSelection() {
      // Check if at least one exercise is selected for each training day
      let allDaysHaveExercises = true;
      programData.trainingDays.forEach(day => {
        if (!programData.workouts[day] || programData.workouts[day].exercises.length === 0) {
          allDaysHaveExercises = false;
        }
      });
      
      if (!allDaysHaveExercises) {
        alert('Please add at least one exercise for each training day.');
        return false;
      }
      
      return true;
    }

    // Event handlers
    document.getElementById('programDuration').addEventListener('change', function() {
      const customGroup = document.getElementById('customDurationGroup');
      if (this.value === 'custom') {
        customGroup.style.display = 'block';
      } else {
        customGroup.style.display = 'none';
      }
    });

    window.selectFrequency = function(frequency) {
      document.querySelectorAll('#step2 .checkbox-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      document.getElementById('freq' + frequency.split('_')[0]).checked = true;
    };

    window.toggleDay = function(day) {
      const checkbox = document.getElementById(day);
      const item = event.currentTarget;
      
      checkbox.checked = !checkbox.checked;
      
      if (checkbox.checked) {
        item.classList.add('selected');
      } else {
        item.classList.remove('selected');
      }
      
      updateDaySelectionCount();
    };

    function updateDaySelectionCount() {
      const selectedDays = document.querySelectorAll('#step3 input[type="checkbox"]:checked').length;
      const expectedDays = programData.frequency ? parseInt(programData.frequency.split('_')[0]) : 0;
      const countDiv = document.getElementById('daySelectionCount');
      
      if (expectedDays > 0) {
        countDiv.textContent = `Selected: ${selectedDays}/${expectedDays} days`;
        if (selectedDays === expectedDays) {
          countDiv.style.color = 'var(--success-color)';
        } else {
          countDiv.style.color = 'var(--secondary-color)';
        }
      }
    }

    window.selectTrainingStyle = function(style) {
      document.querySelectorAll('#step4 .checkbox-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      document.getElementById('style' + style.charAt(0).toUpperCase() + style.slice(1).replace('_', '')).checked = true;
    };

    // Generate workout days interface
    function generateWorkoutDays() {
      const container = document.getElementById('workoutDaysContainer');
      container.innerHTML = '';
      
      programData.trainingDays.forEach((day, index) => {
        const dayContainer = document.createElement('div');
        dayContainer.className = 'workout-day-container';
        dayContainer.innerHTML = `
          <div class="workout-day-header">
            <h4>${day.charAt(0).toUpperCase() + day.slice(1)} Workout</h4>
          </div>
          <div class="exercise-selection">
            <div class="exercise-list" id="exerciseList${index}">
              ${generateExerciseList()}
            </div>
            <div class="selected-exercises" id="selectedExercises${index}">
              <h5>Selected Exercises</h5>
              <div class="exercise-container" id="exerciseContainer${index}"></div>
            </div>
          </div>
        `;
        container.appendChild(dayContainer);
        
        // Initialize workout data for this day
        if (!programData.workouts[day]) {
          programData.workouts[day] = {
            exercises: []
          };
        }
        
        // Add event listeners for exercise selection
        setupExerciseSelection(index, day);
      });
    }

    function generateExerciseList() {
      let html = '';
      
      Object.keys(exerciseDatabase).forEach(category => {
        html += `<div class="exercise-category">${category.replace('_', ' ').toUpperCase()}</div>`;
        
        Object.keys(exerciseDatabase[category]).forEach(subcategory => {
          exerciseDatabase[category][subcategory].forEach(exercise => {
            html += `
              <div class="exercise-item" data-exercise-id="${exercise.id}">
                <div class="exercise-name">${exercise.name}</div>
                <div class="exercise-description">${exercise.description}</div>
              </div>
            `;
          });
        });
      });
      
      return html;
    }

    function setupExerciseSelection(dayIndex, dayName) {
      const exerciseList = document.getElementById(`exerciseList${dayIndex}`);
      const exerciseContainer = document.getElementById(`exerciseContainer${dayIndex}`);
      
      exerciseList.addEventListener('click', function(e) {
        const exerciseItem = e.target.closest('.exercise-item');
        if (exerciseItem) {
          const exerciseId = exerciseItem.dataset.exerciseId;
          addExerciseToWorkout(dayName, exerciseId, dayIndex);
        }
      });
    }

    function addExerciseToWorkout(dayName, exerciseId, dayIndex) {
      // Find exercise details
      let exerciseDetails = null;
      
      Object.keys(exerciseDatabase).forEach(category => {
        Object.keys(exerciseDatabase[category]).forEach(subcategory => {
          const exercise = exerciseDatabase[category][subcategory].find(ex => ex.id === exerciseId);
          if (exercise) {
            exerciseDetails = exercise;
          }
        });
      });
      
      if (exerciseDetails) {
        // Check if exercise already exists
        const existingExercise = programData.workouts[dayName].exercises.find(ex => ex.id === exerciseId);
        if (existingExercise) {
          alert('Exercise already added to this workout.');
          return;
        }
        
        // Add exercise with default configuration
        const exerciseConfig = {
          id: exerciseId,
          name: exerciseDetails.name,
          description: exerciseDetails.description,
          category: exerciseDetails.category,
          subcategory: exerciseDetails.subcategory,
          type: programData.trainingStyle === 'time_based' ? 'duration' : 'reps',
          sets: 3,
          reps: 12,
          duration: 30,
          rest: 60,
          weight: '',
          notes: ''
        };
        
        programData.workouts[dayName].exercises.push(exerciseConfig);
        renderSelectedExercises(dayName, dayIndex);
      }
    }

    function renderSelectedExercises(dayName, dayIndex) {
      const container = document.getElementById(`exerciseContainer${dayIndex}`);
      const exercises = programData.workouts[dayName].exercises;
      
      container.innerHTML = exercises.map((exercise, exerciseIndex) => `
        <div class="selected-exercise" data-exercise-index="${exerciseIndex}">
          <div class="exercise-details">
            <h6>${exercise.name}</h6>
            <div class="exercise-config">
              <div class="config-row">
                <div class="form-group">
                  <label class="form-label">Type</label>
                  <select class="form-select" onchange="updateExerciseConfig('${dayName}', ${exerciseIndex}, 'type', this.value)">
                    <option value="reps" ${exercise.type === 'reps' ? 'selected' : ''}>Reps</option>
                    <option value="duration" ${exercise.type === 'duration' ? 'selected' : ''}>Duration</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Sets</label>
                  <input type="number" class="form-input" value="${exercise.sets}" min="1" 
                         onchange="updateExerciseConfig('${dayName}', ${exerciseIndex}, 'sets', this.value)">
                </div>
                ${exercise.type === 'reps' ? `
                  <div class="form-group">
                    <label class="form-label">Reps</label>
                    <input type="number" class="form-input" value="${exercise.reps}" min="1"
                           onchange="updateExerciseConfig('${dayName}', ${exerciseIndex}, 'reps', this.value)">
                  </div>
                ` : `
                  <div class="form-group">
                    <label class="form-label">Duration (seconds)</label>
                    <select class="form-select" onchange="updateExerciseConfig('${dayName}', ${exerciseIndex}, 'duration', this.value)">
                      <option value="10" ${exercise.duration === 10 ? 'selected' : ''}>10 seconds</option>
                      <option value="20" ${exercise.duration === 20 ? 'selected' : ''}>20 seconds</option>
                      <option value="30" ${exercise.duration === 30 ? 'selected' : ''}>30 seconds</option>
                      <option value="45" ${exercise.duration === 45 ? 'selected' : ''}>45 seconds</option>
                      <option value="60" ${exercise.duration === 60 ? 'selected' : ''}>1 minute</option>
                      <option value="90" ${exercise.duration === 90 ? 'selected' : ''}>1.5 minutes</option>
                      <option value="120" ${exercise.duration === 120 ? 'selected' : ''}>2 minutes</option>
                    </select>
                  </div>
                `}
                <div class="form-group">
                  <label class="form-label">Rest (seconds)</label>
                  <input type="number" class="form-input" value="${exercise.rest}" min="0"
                         onchange="updateExerciseConfig('${dayName}', ${exerciseIndex}, 'rest', this.value)">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Notes (optional)</label>
                <input type="text" class="form-input" value="${exercise.notes}" placeholder="Exercise notes..."
                       onchange="updateExerciseConfig('${dayName}', ${exerciseIndex}, 'notes', this.value)">
              </div>
            </div>
          </div>
          <button class="remove-exercise" onclick="removeExercise('${dayName}', ${exerciseIndex}, ${dayIndex})">Remove</button>
        </div>
      `).join('');
    }

    window.updateExerciseConfig = function(dayName, exerciseIndex, property, value) {
      programData.workouts[dayName].exercises[exerciseIndex][property] = value;
      
      // If type changed, re-render to show appropriate inputs
      if (property === 'type') {
        const dayIndex = programData.trainingDays.indexOf(dayName);
        renderSelectedExercises(dayName, dayIndex);
      }
    };

    window.removeExercise = function(dayName, exerciseIndex, dayIndex) {
      programData.workouts[dayName].exercises.splice(exerciseIndex, 1);
      renderSelectedExercises(dayName, dayIndex);
    };

    // Generate program review
    function generateProgramReview() {
      const reviewContainer = document.getElementById('programReview');
      
      const durationText = programData.duration.includes('_weeks') 
        ? programData.duration.replace('_weeks', ' weeks')
        : programData.duration.replace('_', ' ');
      
      const frequencyText = programData.frequency.replace('_', ' ');
      const styleText = programData.trainingStyle.replace('_', ' ').toUpperCase();
      
      let workoutSummary = '';
      programData.trainingDays.forEach(day => {
        const exercises = programData.workouts[day].exercises;
        workoutSummary += `
          <div class="workout-summary">
            <h5>${day.charAt(0).toUpperCase() + day.slice(1)}</h5>
            <ul>
              ${exercises.map(ex => `
                <li>${ex.name} - ${ex.sets} sets × ${ex.type === 'reps' ? ex.reps + ' reps' : ex.duration + 's'}</li>
              `).join('')}
            </ul>
          </div>
        `;
      });
      
      reviewContainer.innerHTML = `
        <div class="program-summary">
          <h4>Program Summary</h4>
          <div class="summary-grid">
            <div><strong>Title:</strong> ${programData.title}</div>
            <div><strong>Duration:</strong> ${durationText}</div>
            <div><strong>Frequency:</strong> ${frequencyText}</div>
            <div><strong>Training Style:</strong> ${styleText}</div>
            <div><strong>Training Days:</strong> ${programData.trainingDays.join(', ')}</div>
          </div>
          
          ${programData.description ? `
            <div class="description-section">
              <h5>Description</h5>
              <p>${programData.description}</p>
            </div>
          ` : ''}
          
          <div class="workouts-section">
            <h5>Workouts</h5>
            ${workoutSummary}
          </div>
        </div>
      `;
    }

    // Save program to Firestore
    window.saveProgram = async function() {
      const saveBtn = document.getElementById('saveBtn');
      const saveSpinner = document.getElementById('saveSpinner');
      
      try {
        saveBtn.disabled = true;
        saveSpinner.style.display = 'inline-block';
        
        // Get current user
        const user = auth.currentUser;
        if (!user) {
          alert('You must be logged in to save a training program.');
          return;
        }
        
        // Prepare program data for Firestore
        const programToSave = {
          ...programData,
          createdBy: user.uid,
          createdAt: new Date(),
          updatedAt: new Date(),
          isActive: true,
          version: 1
        };
        
        // Save to Firestore
        const docRef = await addDoc(collection(db, 'trainingPrograms'), programToSave);
        
        console.log('Program saved with ID:', docRef.id);
        
        // Show success message
        document.getElementById('successMessage').classList.add('show');
        
        // Close modal after a short delay
        setTimeout(() => {
          closeTrainingBuilder();
        }, 2000);
        
      } catch (error) {
        console.error('Error saving program:', error);
        alert('Failed to save program. Please try again.');
      } finally {
        saveBtn.disabled = false;
        saveSpinner.style.display = 'none';
      }
    };

    // Auth state change
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('User authenticated:', user.uid);
      } else {
        console.log('User not authenticated');
      }
    });

    // Load exercise database from Firestore (optional)
    async function loadExerciseDatabase() {
      try {
        const exercisesSnapshot = await getDocs(collection(db, 'exercises'));
        if (!exercisesSnapshot.empty) {
          // Override local database with Firestore data
          const firestoreExercises = {};
          exercisesSnapshot.forEach(doc => {
            const exercise = doc.data();
            if (!firestoreExercises[exercise.category]) {
              firestoreExercises[exercise.category] = {};
            }
            if (!firestoreExercises[exercise.category][exercise.subcategory]) {
              firestoreExercises[exercise.category][exercise.subcategory] = [];
            }
            firestoreExercises[exercise.category][exercise.subcategory].push({
              id: doc.id,
              ...exercise
            });
          });
          
          // Merge with local database
          Object.assign(exerciseDatabase, firestoreExercises);
          console.log('Exercise database loaded from Firestore');
        }
      } catch (error) {
        console.warn('Could not load exercise database from Firestore, using local data:', error);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadExerciseDatabase();
    });

    // Add some CSS for the workout day containers
    const additionalCSS = `
      <style>
        .workout-day-container {
          border: 2px solid #e9ecef;
          border-radius: var(--border-radius);
          margin-bottom: 25px;
          overflow: hidden;
        }

        .workout-day-header {
          background: var(--primary-color);
          color: white;
          padding: 15px 20px;
          font-size: 1.1rem;
          font-weight: 600;
        }

        .exercise-selection {
          padding: 20px;
        }

        .exercise-selection h5 {
          margin-bottom: 15px;
          color: var(--primary-color);
          font-weight: 600;
        }

        .summary-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
        }

        .summary-grid > div {
          padding: 10px;
          background: var(--light-color);
          border-radius: var(--border-radius);
        }

        .description-section,
        .workouts-section {
          margin-top: 25px;
        }

        .workout-summary {
          background: var(--light-color);
          padding: 15px;
          border-radius: var(--border-radius);
          margin-bottom: 15px;
        }

        .workout-summary h5 {
          color: var(--primary-color);
          margin-bottom: 10px;
          text-transform: capitalize;
        }

        .workout-summary ul {
          margin: 0;
          padding-left: 20px;
        }

        .workout-summary li {
          margin-bottom: 5px;
        }
      </style>
    `;

    document.head.insertAdjacentHTML('beforeend', additionalCSS);

  </script>
</body>
</html>
